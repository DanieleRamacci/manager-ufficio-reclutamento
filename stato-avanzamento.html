<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Stato Avanzamento – Bandi CNR</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    nav a { margin-right: 15px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f4f4f4; }
    .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .pill { display:inline-block; background:#eef2ff; color:#3f51b5; border-radius:999px; padding:2px 8px; font-size:.85rem; margin-left:8px; }
    .small { font-size: 0.9em; color:#666; }
    .link { color:#0b5ed7; text-decoration:none; } .link:hover { text-decoration:underline; }
    .tooltip { position: relative; cursor: pointer; color:#0b5ed7; }
    .tooltip:hover::after { content: attr(data-tip); position: absolute; left: 0; top: 100%; background: #333; color: #fff; padding: 5px; border-radius: 5px; white-space: pre-wrap; width: 320px; z-index: 1; }
    .ok { color:#09814a; font-weight:600; }
    .ko { color:#b00020; font-weight:600; }
    #loading::after { content: ""; display:inline-block; width:14px; height:14px; margin-left:10px; border:2px solid #ccc; border-top:2px solid #333; border-radius:50%; animation: spin .8s linear infinite; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .actions { display:flex; gap:10px; align-items:center; margin-top:6px; }
    .box { border:1px solid #e5e5e5; border-radius:8px; padding:12px; background:#fff; margin:16px 0; }
    .box h3 { margin:0 0 8px 0; font-size:1.05rem; }
    .right { margin-left:auto; }
  </style>
</head>
<body>

  <nav>
    <a href="index.html">Controllo Bandi</a>
    <a href="access.html">Accessibilità URP</a>
    <a href="verifica-access.html">Verifica PDF</a>
    <a href="mobilita-urp.html">Mobilità</a>
    <a href="report-mese.html">Report del Mese</a>
    <strong>• Stato Avanzamento</strong>
  </nav>

  <h2>Stato Avanzamento <span class="pill" id="count">0 risultati</span></h2>
  <div id="loading" class="small" style="display:none;">⏳ Caricamento dati…</div>
  <div class="small" id="metaURP"></div>
  <div class="small" id="metaSOL" style="margin-bottom:12px;"></div>

  <!-- FILTRI -->
  <div class="row small" style="margin-top:8px;">
    <label for="categoria">Categoria:</label>
    <select id="categoria">
      <option value="">Tutte</option>
      <option value="tempo-indeterminato">Tempo Indeterminato</option>
      <option value="tempo-determinato">Tempo Determinato</option>
      <option value="categorie-riservatarie">Categorie Riservatarie</option>
      <option value="direttori-dipartimentiistituti">Direttori Dipartimenti/Istituti</option>
      <option value="avviamento-numerico-selezione-ans-categorie-riservatarie">Avviamento Numerico</option>
      <option value="archivio-vecchio">Archivio Vecchio</option>
    </select>

    <label for="tipoEvento">Tipo evento:</label>
    <select id="tipoEvento">
      <option value="">Tutti</option>
      <option value="graduatoria_mancante">Graduatoria mancante (URP+SOL)</option>
      <option value="graduatoria_pubblicata">Graduatoria pubblicata (URP o SOL)</option>
    </select>

    <label for="fonte">Fonte:</label>
    <select id="fonte">
      <option value="">Tutte</option>
      <option value="urp_nuovo">URP nuovo</option>
      <option value="urp_archivio">URP archivio</option>
    </select>

    <label for="ordinaData">Ordina per data bando:</label>
    <select id="ordinaData">
      <option value="desc">Dal più recente</option>
      <option value="asc">Dal più vecchio</option>
    </select>

    <label for="dal">Dal:</label>
    <input type="date" id="dal" />

    <label for="al">Al:</label>
    <input type="date" id="al" />

    <div class="actions">
      <button onclick="filtra(false)">Applica filtro</button>
      <button onclick="scaricaXLS()">Scarica Excel (.xls)</button>
      <button onclick="scaricaCSV()">Scarica CSV</button>
    </div>
  </div>

  <!-- RIEPILOGO FILTRATO: BANDI IN CORSO PER PROFILO (SIGLA) -->
  <div class="box">
    <div class="row">
      <h3>Riepilogo bandi in corso per profilo (dal Codice Bando)</h3>
      <div class="right actions small">
        <button onclick="scaricaRiepilogoXLS()">Export riepilogo (.xls)</button>
        <button onclick="scaricaRiepilogoCSV()">Export riepilogo (.csv)</button>
      </div>
    </div>
    <table id="tabRiep">
      <thead>
        <tr>
          <th>Profilo (sigla)</th>
          <th>Totale in corso</th>
        </tr>
      </thead>
      <tbody>
        <tr><td class="small" colspan="2">Nessun dato (applica i filtri o attendi il caricamento).</td></tr>
      </tbody>
    </table>
  </div>

  <!-- TABELLA PRINCIPALE -->
  <table id="tab">
    <thead>
      <tr>
        <th>Categoria</th>
        <th>Codice Bando</th>
        <th>Descrizione</th>
        <th>Link URP</th>
        <th>Link SOL</th>
        <th>Data Pubblicazione</th>
        <th>URP</th>
        <th>SOL</th>
        <th>Esito</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  // ---- util base
  function normalizzaCodice(c) { return (c||"").toUpperCase().replace(/\s+/g,"").replace(/\./g,""); }

  // dd-mm-yyyy / yyyy-mm-dd -> Date (00:00)
  function parseToDate(s) {
    if (!s || typeof s !== "string") return null;
    const t = s.trim();
    let m = t.match(/^(\d{2})-(\d{2})-(\d{4})$/);
    if (m) return new Date(+m[3], +m[2]-1, +m[1], 0, 0, 0);
    m = t.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (m) return new Date(+m[1], +m[2]-1, +m[3], 0, 0, 0);
    const d = new Date(t);
    return isNaN(d.getTime()) ? null : new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }
  function dateKey(s) { const d = parseToDate(s); return d ? d.getTime() : 0; }

  // SOLO data di pubblicazione del bando
  function getDataPubblicazioneBando(item) { return item.data_pubblicazione_bando || ""; }

  function estraiCodiceBandoUI(item) {
    const prefer = (item.codice_bando && String(item.codice_bando).trim()) || "";
    if (prefer) return prefer;
    const joined = ((item.titolo_bando||"") + " // " + (item.estratto||"")).toLowerCase();
    let m = joined.match(/\bbando\s*n\.?\s*([0-9]{3}\.[0-9]+(?:\s+[a-zà-ù]+)?)/i);
    if (!m) m = joined.match(/\bcodice\s+bando\s+([0-9]{3}\.[0-9]+(?:\s+[a-zà-ù]+)?)/i);
    if (!m) m = joined.match(/\b([0-9]{3}\.[0-9]+(?:\s+[a-zà-ù]+)?)\b/i);
    return m ? m[1].toUpperCase() : "--";
  }

  // Estrai SIGLA profilo dal Codice Bando (es. "367.443 CTER" -> "CTER")
  function extractSiglaFromCodice(codice) {
    if (!codice) return "ND";
    const parts = String(codice).trim().split(/\s+/);
    // prendi l'ultimo token che sia tutto lettere (>=2)
    for (let i = parts.length - 1; i >= 0; i--) {
      if (/^[A-ZÀ-Ù]{2,}$/.test(parts[i].toUpperCase())) return parts[i].toUpperCase();
    }
    // fallback: cerca pattern finale di lettere
    const m = String(codice).toUpperCase().match(/[A-ZÀ-Ù]{2,}$/);
    return m ? m[0] : "ND";
  }

  async function fetchJSONSafe(url) {
    try { const r = await fetch(url); if (!r.ok) throw new Error(r.status); return await r.json(); }
    catch(e){ console.error("fetch",url,e); return []; }
  }
  async function headLastModified(url, elId) {
    try { const r = await fetch(url, { method:'HEAD' }); const lm = r.headers.get("Last-Modified");
      if (lm) document.getElementById(elId).textContent = `Ultimo agg. ${new Date(lm).toLocaleString()}`;
    } catch(_) {}
  }

  // ---- URL <-> UI sync
  function readFiltersFromURL() {
    const p = new URLSearchParams(location.search);
    return {
      categoria: p.get("categoria") || "",
      tipoEvento: p.get("tipo") || "",
      fonte: p.get("fonte") || "",
      ordinaData: p.get("ord") || "desc",
      dal: p.get("dal") || "",
      al: p.get("al") || ""
    };
  }
  function applyFiltersToUI(f) {
    const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = v; };
    set("categoria",  f.categoria);
    set("tipoEvento", f.tipoEvento);
    set("fonte",      f.fonte);
    set("ordinaData", f.ordinaData);
    set("dal",        f.dal);
    set("al",         f.al);
  }
  function updateURLFromFilters(f, replace = true) {
    const p = new URLSearchParams();
    if (f.categoria)  p.set("categoria", f.categoria);
    if (f.tipoEvento) p.set("tipo", f.tipoEvento);
    if (f.fonte)      p.set("fonte", f.fonte);
    if (f.ordinaData && f.ordinaData !== "desc") p.set("ord", f.ordinaData);
    if (f.dal)        p.set("dal", f.dal);
    if (f.al)         p.set("al", f.al);
    const qs = p.toString();
    const url = qs ? `?${qs}` : location.pathname;
    if (replace) history.replaceState(null, "", url);
    else history.pushState(null, "", url);
  }

  // ---- dati
  let urpData = []; // flatten
  let solData = [];
  let ultimiRows = []; // cache tabella principale renderizzata
  let ultimoRiepilogo = []; // [{sigla, count}] per export

  function buildMatchSOL(codice) {
    const norm = normalizzaCodice(codice);
    if (!norm) return null;
    return solData.find(s => {
      const ns = normalizzaCodice(s.codice);
      return ns && (ns.includes(norm) || norm.includes(ns));
    }) || null;
  }

  // flags graduatoria
  function hasGradURP(item) {
    return !!item.data_pubblicazione_graduatoria || item.graduatoria_presente === true;
  }
  function hasGradSOL(matchSOL) {
    if (!matchSOL) return false;
    return Boolean(
      matchSOL.graduatoria_presente === true ||
      matchSOL.data_pubblicazione_graduatoria ||
      matchSOL.graduatoria_allegato === true
    );
  }

  function filtra(pushState = true) {
    // raccogli filtri
    const categoria = document.getElementById("categoria").value;
    const tipoEv    = document.getElementById("tipoEvento").value;
    const fonte     = document.getElementById("fonte").value;
    const ordData   = document.getElementById("ordinaData").value; // 'desc' | 'asc'
    const dalVal    = document.getElementById("dal").value; // yyyy-mm-dd
    const alVal     = document.getElementById("al").value;

    // aggiorna URL
    if (pushState) {
      updateURLFromFilters({ categoria, tipoEvento: tipoEv, fonte, ordinaData: ordData, dal: dalVal, al: alVal }, false);
    }

    // normalizza range [dal..al]
    const dal = dalVal ? new Date(dalVal + "T00:00:00") : null;
    const al  = alVal  ? new Date(alVal  + "T00:00:00") : null;

    let rows = [];

    urpData.forEach(item => {
      if (categoria && item.categoria !== categoria) return;
      if (fonte && (item.fonte || "") !== fonte) return;

      // data: SOLO pubblicazione del bando
      const dataPub = getDataPubblicazioneBando(item);
      const d = parseToDate(dataPub);
      if (dal && (!d || d < dal)) return;
      if (al  && (!d || d > al))  return;

      const codice = estraiCodiceBandoUI(item);
      const mSOL   = buildMatchSOL(codice);
      const urpOk  = hasGradURP(item);
      const solOk  = hasGradSOL(mSOL);

      // filtro "Tipo evento"
      if (tipoEv === "graduatoria_mancante"   && (urpOk || solOk)) return;
      if (tipoEv === "graduatoria_pubblicata" && !(urpOk || solOk)) return;

      rows.push({
        item, codice, mSOL, urpOk, solOk,
        dataPub,
        dateKey: dateKey(dataPub)
      });
    });

    // ordinamento per data pubblicazione bando
    rows.sort((a,b) => (ordData === "asc" ? a.dateKey - b.dateKey : b.dateKey - a.dateKey));

    // render tabella principale
    const tbody = document.querySelector("#tab tbody");
    tbody.innerHTML = "";
    rows.forEach(({item, codice, mSOL, urpOk, solOk, dataPub}) => {
      const tr = document.createElement("tr");

      const tdCat = document.createElement("td");
      tdCat.textContent = item.categoria || "";
      tr.appendChild(tdCat);

      const tdCod = document.createElement("td");
      tdCod.innerHTML = item.url ? `<a class="link" href="${item.url}" target="_blank">${codice}</a>` : (codice || "--");
      tr.appendChild(tdCod);

      const tdDesc = document.createElement("td");
      tdDesc.innerHTML = `<span class="tooltip" data-tip="${(item.estratto||'').replace(/"/g,'&quot;')}">Mostra</span>`;
      tr.appendChild(tdDesc);

      const tdURP = document.createElement("td");
      tdURP.innerHTML = item.url ? `<a class="link" href="${item.url}" target="_blank">Apri</a>` : "—";
      tr.appendChild(tdURP);

      const tdSOL = document.createElement("td");
      if (mSOL) {
        const linkSOL = `https://selezionionline.cnr.it/jconon/call-detail?callCode=${encodeURIComponent(mSOL.codice)}`;
        tdSOL.innerHTML = `<a class="link" href="${linkSOL}" target="_blank">Vai</a>`;
      } else { tdSOL.textContent = "—"; }
      tr.appendChild(tdSOL);

      const tdData = document.createElement("td");
      tdData.textContent = dataPub || "";
      tr.appendChild(tdData);

      const tdURPst = document.createElement("td");
      tdURPst.innerHTML = urpOk ? `<span class="ok">✅</span>` : `<span class="ko">❌</span>`;
      tr.appendChild(tdURPst);

      const tdSOLst = document.createElement("td");
      tdSOLst.innerHTML = solOk ? `<span class="ok">✅</span>` : `<span class="ko">❌</span>`;
      tr.appendChild(tdSOLst);

      const tdEsito = document.createElement("td");
      tdEsito.textContent = urpOk && solOk ? "OK su URP e SOL"
                          : (!urpOk && !solOk ? "Manca su URP e SOL (in corso)"
                          : (urpOk && !solOk ? "Manca su SOL" : "Manca su URP"));
      tr.appendChild(tdEsito);

      tbody.appendChild(tr);
    });

    // cache per export tabella
    ultimiRows = rows;

    document.getElementById("count").textContent =
      document.querySelectorAll("#tab tbody tr").length + " risultati";

    // ---- RIEPILOGO (solo bandi in corso) ----
    const riepilogo = buildRiepilogo(rows);  // [{sigla, count}]
    ultimoRiepilogo = riepilogo;
    renderRiepilogo(riepilogo);
  }

  // Costruisce riepilogo per profilo (sigla) limitato ai bandi in corso (graduatoria mancante ovunque)
  function buildRiepilogo(rows) {
    const counter = {};
    rows.forEach(r => {
      if (!(r.urpOk === false && r.solOk === false)) return; // solo "in corso"
      const sigla = extractSiglaFromCodice(r.codice) || "ND";
      counter[sigla] = (counter[sigla] || 0) + 1;
    });
    // ordina per count desc poi sigla asc
    const out = Object.entries(counter).map(([sigla, count]) => ({ sigla, count }));
    out.sort((a,b) => b.count - a.count || a.sigla.localeCompare(b.sigla));
    return out;
  }

  function renderRiepilogo(riep) {
    const tbody = document.querySelector("#tabRiep tbody");
    tbody.innerHTML = "";
    if (!riep.length) {
      tbody.innerHTML = `<tr><td class="small" colspan="2">Nessun bando in corso con i filtri attuali.</td></tr>`;
      return;
    }
    riep.forEach(({sigla, count}) => {
      const tr = document.createElement("tr");
      const td1 = document.createElement("td"); td1.textContent = sigla; tr.appendChild(td1);
      const td2 = document.createElement("td"); td2.textContent = count; tr.appendChild(td2);
      tbody.appendChild(tr);
    });
  }

  // ===== EXPORT TABELLA PRINCIPALE =====
  function csvEscape(s) {
    if (s == null) return "";
    const str = String(s);
    return /[",\n;]/.test(str) ? `"${str.replace(/"/g,'""')}"` : str;
  }
  function htmlEscape(s) {
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  function scaricaCSV() {
    const headers = [
      "Categoria","Codice Bando","Descrizione","Link URP","Link SOL",
      "Data Pubblicazione","URP","SOL","Esito"
    ];
    const rows = [headers];
    ultimiRows.forEach(({item, codice, mSOL, urpOk, solOk, dataPub}) => {
      const linkURP = item.url || "";
      const linkSOL = mSOL ? `https://selezionionline.cnr.it/jconon/call-detail?callCode=${encodeURIComponent(mSOL.codice)}` : "";
      const descr = (item.estratto || "").replace(/\s+/g," ").trim();
      const esito = urpOk && solOk ? "OK su URP e SOL"
                  : (!urpOk && !solOk ? "Manca su URP e SOL (in corso)"
                  : (urpOk && !solOk ? "Manca su SOL" : "Manca su URP"));
      rows.push([
        item.categoria || "",
        codice || "",
        descr,
        linkURP,
        linkSOL,
        dataPub || "",
        urpOk ? "✅" : "❌",
        solOk ? "✅" : "❌",
        esito
      ]);
    });
    const csvBody = rows.map(r => r.map(csvEscape).join(";")).join("\n");
    const BOM = "\uFEFF";
    const blob = new Blob([BOM + csvBody], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement("a"), {
      href: url,
      download: `stato-avanzamento_${new Date().toISOString().slice(0,10)}.csv`
    });
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function scaricaXLS() {
    let html = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office"
            xmlns:x="urn:schemas-microsoft-com:office:excel"
            xmlns="http://www.w3.org/TR/REC-html40">
      <head><meta charset="UTF-8"><title>Stato Avanzamento</title></head>
      <body>
      <table border="1">
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Codice Bando</th>
            <th>Descrizione</th>
            <th>Link URP</th>
            <th>Link SOL</th>
            <th>Data Pubblicazione</th>
            <th>URP</th>
            <th>SOL</th>
            <th>Esito</th>
          </tr>
        </thead>
        <tbody>
    `;
    ultimiRows.forEach(({item, codice, mSOL, urpOk, solOk, dataPub}) => {
      const linkURP = item.url || "";
      const linkSOL = mSOL ? `https://selezionionline.cnr.it/jconon/call-detail?callCode=${encodeURIComponent(mSOL.codice)}` : "";
      const descr = (item.estratto || "").replace(/\s+/g," ").trim();
      const esito = urpOk && solOk ? "OK su URP e SOL"
                  : (!urpOk && !solOk ? "Manca su URP e SOL (in corso)"
                  : (urpOk && !solOk ? "Manca su SOL" : "Manca su URP"));
      html += `
        <tr>
          <td>${htmlEscape(item.categoria || "")}</td>
          <td>${htmlEscape(codice || "")}</td>
          <td>${htmlEscape(descr)}</td>
          <td>${linkURP ? `<a href="${htmlEscape(linkURP)}">Apri</a>` : ""}</td>
          <td>${linkSOL ? `<a href="${htmlEscape(linkSOL)}">Vai</a>` : ""}</td>
          <td>${htmlEscape(dataPub || "")}</td>
          <td>${urpOk ? "✅" : "❌"}</td>
          <td>${solOk ? "✅" : "❌"}</td>
          <td>${htmlEscape(esito)}</td>
        </tr>`;
    });
    html += `</tbody></table></body></html>`;

    const blob = new Blob([html], { type: "application/vnd.ms-excel;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement("a"), {
      href: url,
      download: `stato-avanzamento_${new Date().toISOString().slice(0,10)}.xls`
    });
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ===== EXPORT RIEPILOGO =====
  function scaricaRiepilogoCSV() {
    const rows = [["Profilo (sigla)","Totale in corso"]];
    ultimoRiepilogo.forEach(r => rows.push([r.sigla, r.count]));
    const body = rows.map(r => r.map(csvEscape).join(";")).join("\n");
    const BOM = "\uFEFF";
    const blob = new Blob([BOM + body], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement("a"), {
      href: url,
      download: `riepilogo_in_corso_${new Date().toISOString().slice(0,10)}.csv`
    });
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function scaricaRiepilogoXLS() {
    let html = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office"
            xmlns:x="urn:schemas-microsoft-com:office:excel"
            xmlns="http://www.w3.org/TR/REC-html40">
      <head><meta charset="UTF-8"><title>Riepilogo in corso</title></head>
      <body>
      <table border="1">
        <thead>
          <tr><th>Profilo (sigla)</th><th>Totale in corso</th></tr>
        </thead>
        <tbody>
    `;
    ultimoRiepilogo.forEach(r => {
      html += `<tr><td>${htmlEscape(r.sigla)}</td><td>${htmlEscape(r.count)}</td></tr>`;
    });
    html += `</tbody></table></body></html>`;

    const blob = new Blob([html], { type: "application/vnd.ms-excel;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement("a"), {
      href: url,
      download: `riepilogo_in_corso_${new Date().toISOString().slice(0,10)}.xls`
    });
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ---- init
  async function init() {
    document.getElementById("loading").style.display = "block";

    // 1) leggi filtri da URL e applica UI
    applyFiltersToUI(readFiltersFromURL());

    // 2) carica dati
    const urpJson = await fetchJSONSafe("/_static/bandi-completi-urp.json");
    if (Array.isArray(urpJson)) {
      urpData = urpJson.map(b => ({ ...b, categoria: b.categoria || (b.fonte || "") }));
    } else {
      urpData = Object.entries(urpJson).flatMap(([categoria, bandi]) =>
        (Array.isArray(bandi) ? bandi : []).map(b => ({ ...b, categoria }))
      );
    }
    headLastModified("/_static/bandi-completi-urp.json","metaURP");

    const solJson = await fetchJSONSafe("/_static/bandi-concorsi-pubblici-sol.json");
    solData = Array.isArray(solJson) ? solJson : [];
    headLastModified("/_static/bandi-concorsi-pubblici-sol.json","metaSOL");

    document.getElementById("loading").style.display = "none";

    // 3) prima render coerente con URL
    filtra(true);

    // 4) back/forward browser: rilegge dai parametri
    window.addEventListener("popstate", () => {
      applyFiltersToUI(readFiltersFromURL());
      filtra(false);
    });

    // 5) cambi immediati → pushState della URL
    ["categoria","tipoEvento","fonte","ordinaData","dal","al"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("change", () => filtra(true));
    });
  }

  document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
