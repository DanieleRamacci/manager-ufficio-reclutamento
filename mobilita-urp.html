<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Mobilit√† e Comandi CNR</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    .tooltip { position: relative; cursor: pointer; }
    .tooltip:hover::after {
      content: attr(data-tip);
      position: absolute; left: 0; top: 100%;
      background: #333; color: #fff; padding: 5px; border-radius: 5px;
      white-space: pre-wrap; width: 300px; z-index: 1;
    }
    #loading::after {
      content: ""; display: inline-block; width: 14px; height: 14px; margin-left: 10px;
      border: 2px solid #ccc; border-top: 2px solid #333; border-radius: 50%;
      animation: spin 0.8s linear infinite; vertical-align: middle;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .update-buttons { margin-top: 10px; }
    .update-buttons button { margin-right: 10px; }
  </style>
</head>
<body>
 
  <nav style="margin-bottom: 20px;">
    <a href="index.html" style="margin-right: 15px;">Controllo Bandi</a>
    <a href="access.html" style="margin-right: 15px;">Accessibilit√† URP</a>
    <a href="verifica-access.html" style="margin-right: 15px;">Verifica PDF</a>

    <a href="mobilita-urp.html" style="margin-right: 15px;">mobilit√†</a>
    <a href="report-mese.html" style="margin-right: 15px;">Report del Mese</a>

  </nav>

  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h1>Bandi Mobilit√† e Comandi CNR</h1>
    <div style="text-align: right; font-size: 0.9em; color: gray;">
      <div id="lastUpdateMobilita"></div>
    </div>
  </div>

  <div id="loading" style="color: #444; margin-top: 10px; font-style: italic; display: none;">
    ‚è≥ Caricamento dati...
  </div>

  <div class="update-buttons">
    <button onclick="aggiornaMobilita()">üîÑ Aggiorna Mobilit√†/Comandi</button>
  </div>

  <label for="mese">Filtra per mese:</label>
  <select id="mese">
    <option value="">Tutti</option>
    <option value="01">Gennaio</option>
    <option value="02">Febbraio</option>
    <option value="03">Marzo</option>
    <option value="04">Aprile</option>
    <option value="05">Maggio</option>
    <option value="06">Giugno</option>
    <option value="07">Luglio</option>
    <option value="08">Agosto</option>
    <option value="09">Settembre</option>
    <option value="10">Ottobre</option>
    <option value="11">Novembre</option>
    <option value="12">Dicembre</option>
  </select>

  <label for="anno">Anno:</label>
  <input type="text" id="anno" placeholder="es. 2025" size="4">

  <label>
    <input type="checkbox" id="soloGraduatoria">
    Solo bandi con graduatoria pubblicata in quel mese
  </label>

  <label for="tipologiaFiltro">Tipologia:</label>
  <select id="tipologiaFiltro">
    <option value="">Tutte</option>
    <option value="mobilita">Mobilit√†</option>
    <option value="comando">Comando</option>
  </select>

  <button onclick="filtraBandi()">Applica filtro</button>

  <table id="tabellaBandi">
    <thead>
      <tr>
        <th>Codice</th>
        <th>Tipologia</th>
        <th>Descrizione</th>
        <th>Link</th>
        <th>Protocollo</th>
        <th>Data Pubblicazione</th>
        <th>Graduatoria URP</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let mobilitaData = [];

    const NFD = s => (s || "").normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    const norm = s => NFD(String(s || '')).toLowerCase().trim();

    async function getLastModified(url, elementId) {
      try {
        const res = await fetch(url, { method: 'HEAD' });
        const lastMod = res.headers.get("Last-Modified");
        if (lastMod) {
          const parsed = new Date(lastMod);
          document.getElementById(elementId).textContent =
            `Ultimo aggiornamento: ${parsed.toLocaleString()}`;
        }
      } catch {
        document.getElementById(elementId).textContent = `‚ö†Ô∏è Errore meta info per ${url}`;
      }
    }

    async function aggiornaMobilita() {
      const el = document.getElementById("loading");
      el.style.display = "block";
      el.textContent = "‚è≥ Aggiornamento dati in corso...";
      try {
        await fetch("/api/run", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ urp: false, sol: false, mob: true })
        });
        // Non blocchiamo: ricarichiamo i dati e avviamo polling finch√© compare
        startPollingMobilita(true);
      } catch (e) {
        alert("Errore nell'aggiornamento mobilit√†");
        console.error(e);
      }
    }

    async function fetchJSONSafe(url) {
      try {
        const res = await fetch(url);
        if (!res.ok) return [];
        return await res.json();
      } catch {
        return [];
      }
    }

    function parseMeseAnno(dateStr) {
      if (!dateStr) return { mese: "", anno: "" };
      let m;
      if ((m = dateStr.match(/^(\d{2})-(\d{2})-(\d{4})$/))) {
        // DD-MM-YYYY
        return { mese: m[2], anno: m[3] };
      } else if ((m = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/))) {
        // YYYY-MM-DD
        return { mese: m[2], anno: m[1] };
      } else if ((m = dateStr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/))) {
        // DD/MM/YYYY
        return { mese: m[2], anno: m[3] };
      } else if ((m = dateStr.match(/^(\d{4})\/(\d{2})\/(\d{2})$/))) {
        // YYYY/MM/DD
        return { mese: m[2], anno: m[1] };
      }
      return { mese: "", anno: "" };
    }

    function renderTable() {
      const mese = document.getElementById("mese").value;
      const anno = document.getElementById("anno").value;
      const soloGraduatoria = document.getElementById("soloGraduatoria").checked;
      const tipologiaSel = norm(document.getElementById("tipologiaFiltro").value);
      const tbody = document.querySelector("#tabellaBandi tbody");
      tbody.innerHTML = "";

      mobilitaData.forEach(item => {
        const dataPub = item.data_pubblicazione_bando || item.data_pubblicazione || item.data || "";
        const { mese: meseDoc, anno: annoDoc } = parseMeseAnno(dataPub);

        if (mese && meseDoc && mese !== meseDoc) return;
        if (anno && annoDoc && anno !== annoDoc) return;

        if (soloGraduatoria && !(item.graduatoria_presente || item.data_pubblicazione_graduatoria)) return;

        const tipologiaItem = norm(item.tipologia || item.tipo || "");
        if (tipologiaSel && tipologiaSel !== tipologiaItem) return;

        const tr = document.createElement("tr");

        // Codice
        const codiceCell = document.createElement("td");
        const codice = item.codice || item.codice_bando || item.code || "--";
        codiceCell.textContent = codice;
        tr.appendChild(codiceCell);

        // Tipologia
        const tipoCell = document.createElement("td");
        tipoCell.textContent = item.tipologia || item.tipo || "-";
        tr.appendChild(tipoCell);

        // Descrizione (tooltip)
        const desc = document.createElement("td");
        const estrattoTxt = (item.estratto || item.descrizione || item.title || "").toString();
        const tip = estrattoTxt.replace(/"/g, "&quot;").slice(0, 2000);
        desc.innerHTML = tip ? `<span class="tooltip" data-tip="${tip}">Mostra</span>` : "--";
        tr.appendChild(desc);

        // Link
        const link = document.createElement("td");
        const url = item.url || item.link || item.href || "";
        link.innerHTML = url ? `<a href="${url}" target="_blank">Apri</a>` : "--";
        tr.appendChild(link);

        // Protocollo
        const protocollo = document.createElement("td");
        protocollo.textContent = item.numero_protocollo || item.protocollo || item.prot || "";
        tr.appendChild(protocollo);

        // Data
        const dataPubCell = document.createElement("td");
        dataPubCell.textContent = dataPub || "--";
        tr.appendChild(dataPubCell);

        // Graduatoria
        const gradCell = document.createElement("td");
        gradCell.textContent = (item.graduatoria_presente || item.data_pubblicazione_graduatoria) ? "‚úÖ" : "--";
        tr.appendChild(gradCell);

        tbody.appendChild(tr);
      });
    }

    function filtraBandi() { renderTable(); }

    async function loadOnce() {
      const loading = document.getElementById("loading");
      loading.style.display = "block";
      loading.textContent = "‚è≥ Caricamento iniziale...";

      mobilitaData = await fetchJSONSafe("/_static/bandi-mobilita.json"); // se non c'√® ‚Üí []
      if (mobilitaData.length > 0) {
        getLastModified("/_static/bandi-mobilita.json", "lastUpdateMobilita");
      }
      loading.style.display = "none";
      renderTable();
    }

    function startPollingMobilita(forceMsg = false) {
      const loading = document.getElementById("loading");
      let tries = 0, maxTries = 90; // ~15 minuti (ogni 10s)
      if (forceMsg) {
        loading.style.display = "block";
        loading.textContent = "‚è≥ In attesa che i dati Mobilit√† vengano generati...";
      }
      const iv = setInterval(async () => {
        tries++;
        const tmp = await fetchJSONSafe("/_static/bandi-mobilita.json");
        if (Array.isArray(tmp) && tmp.length > 0) {
          mobilitaData = tmp;
          getLastModified("/_static/bandi-mobilita.json", "lastUpdateMobilita");
          loading.style.display = "none";
          renderTable();
          clearInterval(iv);
        } else if (tries >= maxTries) {
          loading.textContent = "‚ö†Ô∏è Dati Mobilit√† non disponibili al momento.";
          clearInterval(iv);
        }
      }, 10000);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await loadOnce();
      if (mobilitaData.length === 0) startPollingMobilita();
    });
  </script>
</body>
</html>
